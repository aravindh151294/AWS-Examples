#!/usr/bin/env bash

echo "== delete-object"

# 1. Check if bucket name is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <bucket-name>"
    exit 1
fi

BUCKET_NAME="$1"

echo "ðŸ” Fetching list of objects from: $BUCKET_NAME"

# 2. Get the list of objects and transform them into the Delete JSON format
# .Contents[]      -> Iterate through every file found
# | {Key: .Key}    -> Create a new object for each, keeping only the Key
# [ ... ]          -> Put those objects into an array
# {Objects: ...}   -> Wrap that array in the "Objects" parent key
DELETE_JSON=$(aws s3api list-objects --bucket "$BUCKET_NAME" | jq '{Objects: [.Contents[]? | {Key: .Key}], Quiet: false}')

# 3. Check if any objects were found
if [ "$DELETE_JSON" == "null" ] || [ "$(echo "$DELETE_JSON" | jq '.Objects | length')" -eq 0 ]; then
    echo "Bucket is already empty or does not exist."
    exit 0
fi

echo "Deleting the following JSON structure:"
echo "$DELETE_JSON" | jq .

# 4. Perform the bulk delete
aws s3api delete-objects \
    --bucket "$BUCKET_NAME" \
    --delete "$DELETE_JSON"